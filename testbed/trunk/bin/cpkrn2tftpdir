#!/bin/bash
if [[ -z $1 ]]
then 
	PROGNAME=`basename $0`
	echo "Use: $PROGNAME <kernel source dir>"
	exit 
fi
TFTP_DIR=/var/lib/tftpboot/ltsp/i386/kfir/compound
# This is the root filesystem that the pxeboot clients have as thier root nfs
CLIENT_ROOT_FS=/opt/ltsp/i386 
KERNEL_DIR=$1
BZIMAGE=arch/i386/boot/bzImage
KERNEL_PREFIX="vmlinux-"
CONFIG_PREFIX="config-"
KERNEL_CONFIG="$KERNEL_DIR/.config"


get_kernel_local_version()
{
	grep "LOCALVERSION=" $KERNEL_CONFIG | cut -f 2 -d '"'
}

get_kernel_param_from_makefile()
{
	grep $1 $KERNEL_DIR/Makefile | head -n 1 | cut -f 3 -d ' '
}

get_kernel_version()
{
	version=`get_kernel_param_from_makefile "VERSION"`
	patchlevel=`get_kernel_param_from_makefile "PATCHLEVEL"`
	sublevel=`get_kernel_param_from_makefile "SUBLEVEL"`
	extraversion=`get_kernel_param_from_makefile "EXTRAVERSION"`
	kernel_version="${version}.${patchlevel}.${sublevel}"

	# if extra version exist we'll concatenate it to the kernel version string
	if [[ $extraversion ]]
	then
		kernel_version="${kernel_version}${extraversion}"
	fi

	# Include the user added local version from the kernel config
	localversion=`get_kernel_local_version`

	if [[ $localversion ]]
	then
		kernel_version="${kernel_version}${localversion}"
	fi
	
	#return 
	echo $kernel_version
}

# gets kernel version
copy_kernel_to_tftp_dir()
{
	kver=$1
	kernel_filename="${KERNEL_PREFIX}${kver}"
	config_filename="${CONFIG_PREFIX}${kver}"
	cp -v $KERNEL_DIR/$BZIMAGE $TFTP_DIR/$kernel_filename
	cp -v $KERNEL_CONFIG $TFTP_DIR/$config_filename
}

install_modules_to_client_root_nfs()
{
	cd $KERNEL_DIR &&
	make modules_install INSTALL_MOD_PATH=$CLIENT_ROOT_FS &&
	cd -
}

main()
{
	kver=`get_kernel_version`
	copy_kernel_to_tftp_dir $kver
	install_modules_to_client_root_nfs
}

main
